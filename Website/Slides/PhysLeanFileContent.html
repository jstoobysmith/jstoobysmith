<!--
This file is corresponds to one of my talks.

bundle exec jekyll serve

-->


<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>PhysLean</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reset.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/theme/white.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/plugin/highlight/monokai.min.css">



  <style>
    .reveal h1,
    .reveal h2,
    .reveal h3,
    .reveal h4,
    .reveal h5,
    .reveal h6 {
      text-transform: none;
    }
  </style>

  <style>
    pre code {
      font-size: 0.7em !important;
    }
  </style>
  <style>
    /* Change comment color in Highlight.js */
    .hljs-comment {
      color: #96b596; /* Specify your desired color here */
    }
  </style>

  <!-- Predefined functions for use within the code. -->
  <script src="Functions.js"></script>
</head>


<body>
  <div class="reveal">
    <div class="slides">

      <!--
Slides start here
..........................
..........................
..........................
..........................
..........................
-->


<section>
  <h3>PhysLean files</h3>
  <div style="display: flex;">
    <div id="lean-files-container"
      style="height: 600px; overflow-y: auto; border: 1px solid #4CAF50; padding: 10px; width: 30%; text-align: left; font-size: 0.5em; background-color: #2E3440; color: #A3BE8C; font-family: monospace;">
    </div>
    <pre id="EM-slide-1"
      style="border: 2px solid #ccc; padding: 15px; border-radius: 5px; width: 60%; margin-left: 20px;">Click a file on the left to see code.</pre>
  </div>
  <script>
    renderLeanFiles();
  </script>
</section>

<!--

Veiwing the dependency graph of PhysLean

-->
<!-- Downloading dj -->
<script src="//d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/@hpcc-js/wasm@2.20.0/dist/graphviz.umd.js"></script>
<script src="https://unpkg.com/d3-graphviz@5.6.0/build/d3-graphviz.js"></script>
<script>
  async function filterDot(dotText, sources, targets) {
    const edgeRegex = /"([^"]+)"\s*->\s*"([^"]+)"/g;
    const adj = {}, revAdj = {};
    let match;

    while ((match = edgeRegex.exec(dotText)) !== null) {
      const [_, from, to] = match;
      (adj[from] ||= new Set()).add(to);
      (revAdj[to] ||= new Set()).add(from);
    }

    function bfs(startNodes, graph) {
      const visited = new Set(startNodes);
      const queue = [...startNodes];
      while (queue.length) {
        const node = queue.shift();
        for (const next of graph[node] || []) {
          if (!visited.has(next)) {
            visited.add(next);
            queue.push(next);
          }
        }
      }
      return visited;
    }

    const forward = bfs(sources, adj);
    const backward = bfs(targets, revAdj);
    const keep = new Set([...forward].filter(n => backward.has(n)));

    // Filter nodes and edges
    const nodeRegex = /"([^"]+)"\s*\[.*?];/g;
    let result = 'digraph "import_graph" {\n';

    while ((match = nodeRegex.exec(dotText)) !== null) {
      const node = match[1];
      if (keep.has(node)) result += `  ${match[0]}\n`;
    }

    edgeRegex.lastIndex = 0;
    while ((match = edgeRegex.exec(dotText)) !== null) {
      const [_, from, to] = match;
      if (keep.has(from) && keep.has(to)) result += `  "${from}" -> "${to}";\n`;
    }

    result += '}';

    return result;
  }
  function renderGraph(sources, targets) {
    console.log("Rendering graph with sources:", sources, "and targets:", targets);
    fetch('./Images/my_graph.dot')
      .then(response => response.text())
      .then(dotText =>

      filterDot(
        dotText,
        sources,
        targets
      ))
      .then(filteredDot => {

        d3.select("#graph")
          .style("border", "1px solid black")
          .graphviz()
          .zoom(true)
          .fit(true)
          .width("100%")
          .height("400px")
          .renderDot(filteredDot);
      })
      .catch(error => console.error('Error fetching dot file:', error));
  }
</script>

<section>
<div style="display: flex; gap: 1em; font-size: 0.5em;">
  <div style="flex: 1;">
    <label for="sources-list" style="text-align: left; font-size: 0.8em;">Sources:</label>
    <div id="sources-list" style="height: 150px; width: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; text-align: left; font-size: 0.7em;
      border: 1px solid #4CAF50; background-color: #2E3440; color: #A3BE8C; font-family: monospace;"></div>
  </div>
  <div style="flex: 1;">
    <label for="targets-list" style="text-align: left; font-size: 0.8em;">Targets:</label>
    <div id="targets-list" style="height: 150px; width: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; text-align: left; font-size: 0.7em;
      border: 1px solid #4CAF50; background-color: #2E3440; color: #A3BE8C; font-family: monospace;"></div>
  </div>
</div>
<button id="renderBtn" style="font-size: 0.5em; margin-top: 0.5em;">Render Graph</button>
<!-- Container for the graph -->
<div id="graph"></div>
</section>

<script>
  const sourcesList = document.getElementById('sources-list');
  const targetsList = document.getElementById('targets-list');
  const renderBtn = document.getElementById('renderBtn');

  function updateGraph() {
    const selectedSources = document.querySelectorAll('input[name="source-checkbox"]:checked');
    const selectedTargets = document.querySelectorAll('input[name="target-checkbox"]:checked');

    const sources = Array.from(selectedSources).map(input => input.value);
    const targets = Array.from(selectedTargets).map(input => input.value);

    console.log("Sources:", sources);
    console.log("Targets:", targets);
    if (sources.length > 0 && targets.length > 0) {
        renderGraph(sources, targets);
    }
  }

  function populateLists(dotText) {
    const nodeRegex = /"([^"]+)"\s*\[/g;
    const nodes = new Set();
    let match;
    while ((match = nodeRegex.exec(dotText)) !== null) {
      nodes.add(match[1]);
    }

    const sortedNodes = Array.from(nodes).sort();

    sortedNodes.forEach(node => {
      // Create for sources list
      const sourceDiv = document.createElement('div');
      const sourceCheckbox = document.createElement('input');
      sourceCheckbox.type = 'checkbox';
      sourceCheckbox.name = 'source-checkbox';
      sourceCheckbox.value = node;
      sourceCheckbox.id = `source-${node}`;
      const sourceLabel = document.createElement('label');
      sourceLabel.htmlFor = `source-${node}`;
      sourceLabel.textContent = node;
      sourceDiv.appendChild(sourceCheckbox);
      sourceDiv.appendChild(sourceLabel);
      sourcesList.appendChild(sourceDiv);

      // Create for targets list
      const targetDiv = document.createElement('div');
      const targetCheckbox = document.createElement('input');
      targetCheckbox.type = 'checkbox';
      targetCheckbox.name = 'target-checkbox';
      targetCheckbox.value = node;
      targetCheckbox.id = `target-${node}`;
      const targetLabel = document.createElement('label');
      targetLabel.htmlFor = `target-${node}`;
      targetLabel.textContent = node;
      targetDiv.appendChild(targetCheckbox);
      targetDiv.appendChild(targetLabel);
      targetsList.appendChild(targetDiv);
    });

    // Set initial values and render
    const initialSource = "PhysLean.ClassicalMechanics.HamiltonsEquations";
    const initialTarget = "PhysLean";

    // Read initial sources and targets from URL parameters.
    // Example: ?sources=Source1,Source2&targets=Target1
    // If not provided, use the default values defined in initialSource and initialTarget.
    const urlParams = new URLSearchParams(window.location.search);
    const sourcesFromUrl = urlParams.get('sources');
    const targetsFromUrl = urlParams.get('targets');

    let sourcesToCheck = sourcesFromUrl ? sourcesFromUrl.split(',') : [initialSource];
    let targetsToCheck = targetsFromUrl ? targetsFromUrl.split(',') : [initialTarget];

    // If sources or targets are provided in the URL, replace the defaults.
    if (sourcesFromUrl) {
      sourcesToCheck = sourcesFromUrl.split(',');
    }

    if (targetsFromUrl) {
      targetsToCheck = targetsFromUrl.split(',');
    }

    sourcesToCheck.forEach(source => {
      const checkbox = document.getElementById(`source-${source}`);
      if (checkbox) checkbox.checked = true;
    });

    targetsToCheck.forEach(target => {
      const checkbox = document.getElementById(`target-${target}`);
      if (checkbox) checkbox.checked = true;
    });

    updateGraph();
  }

  // Fetch the dot file to populate the lists
  fetch('./Images/my_graph.dot')
    .then(response => response.text())
    .then(populateLists)
    .catch(error => console.error('Error fetching or parsing dot file:', error));

  renderBtn.addEventListener('click', updateGraph);
</script>


  <!--
End matter
..........................
..........................
..........................
..........................
..........................
-->
    </div>
  </div>

  <script src="dist/reveal.js"></script>
  <script src="plugin/highlight/highlight.js"></script>
  <script src="plugin/math/math.js"></script>
  <script src="plugin/notes/notes.js"></script>
  <script src="js/lean.min.js"></script>
  <script src="js/lean-goal.js"></script>
  <script src="js/merge-html.js"></script>
  <script src="js/inline_svg.js"></script>
  <script>
    RevealHighlight().hljs.addPlugin(mergeHTMLPlugin);
    Reveal.initialize({
      mathjax3: {
        mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js',
        loader: { load: ['[tex]/mathtools', '[tex]/centernot'] },
        tex: {
          packages: { '[+]': ['mathtools', 'centernot'] },
        },
        chtml: {
          mtextFont: 'Source Sans Pro',
        },
        options: {
          skipHtmlTags: { '[-]': ['code', 'pre'] },
        },
      },
      katex: {
        macros: {
          "\\smallunderbrace":
            String.raw`{\tiny\underbrace{\huge{#1}}_{\huge\scriptsize#2}}`
        },
        trust: true,
        strict: false,
        ignoredTags: ['script', 'noscript', 'style'],
      },
      plugins: [
        RevealInlineSvg,
        RevealHighlight,
        RevealMath.KaTeX,
        RevealNotes,
      ],
      history: true,
      center: false,
      // defaultTiming: 40,
      // slideNumber: 'c/t',
      // width: 1280*0.96,
      // height: 1024*0.96,
      // width: 1856,
      // height: 1016,
      margin: 0.04,
      navigationMode: 'linear',
      totalTime: 25 * 60,
      // showNotes: 'separate-page'
      autoAnimateEasing: 'ease-out',
      autoAnimateDuration: 0.8,
      autoAnimateUnmatched: false,
    });
  </script>


</body>

</html>
